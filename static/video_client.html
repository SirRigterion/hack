<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e9ecef;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .room-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .participants-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .participant {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .participant.host {
            border-left-color: #28a745;
        }
        
        .participant.muted {
            opacity: 0.6;
        }
        
        .participant-name {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .participant-status {
            font-size: 12px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• –í–∏–¥–µ–æ–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ —Å WebRTC</p>
        </div>

        <!-- –§–æ—Ä–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="connectionForm">
            <div class="form-group">
                <label for="roomCode">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</label>
                <input type="text" id="roomCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" value="ABC12345">
            </div>
            <div class="form-group">
                <label for="userName">–í–∞—à–µ –∏–º—è:</label>
                <input type="text" id="userName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å">
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                <button class="btn btn-success" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div id="status" class="status disconnected">
            –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ -->
        <div id="roomInfo" class="room-info" style="display: none;">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ</h3>
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> <span id="roomName"></span></p>
            <p><strong>–ö–æ–¥:</strong> <span id="roomCodeDisplay"></span></p>
            <p><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> <span id="participantsCount">0</span></p>
        </div>

        <!-- –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div id="videoContainer" class="video-container" style="display: none;">
            <div class="video-wrapper">
                <video id="localVideo" autoplay muted></video>
                <div class="video-label">–í—ã</div>
            </div>
            <div id="remoteVideos"></div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div id="controls" class="controls" style="display: none;">
            <button id="muteBtn" class="btn btn-primary" onclick="toggleMute()">üîá –ó–∞–≥–ª—É—à–∏—Ç—å</button>
            <button id="videoBtn" class="btn btn-primary" onclick="toggleVideo()">üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
            <button id="screenBtn" class="btn btn-success" onclick="toggleScreenShare()">üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞</button>
            <button id="leaveBtn" class="btn btn-danger" onclick="leaveRoom()">üö™ –ü–æ–∫–∏–Ω—É—Ç—å</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
        <div id="participantsList" class="participants-list" style="display: none;">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div id="participants"></div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messages"></div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let pc, ws, localStream, roomCode, userName, isConnected = false;
        let participants = new Map();
        let remoteStreams = new Map();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∞
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                showMessage('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω', 'success');
                
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∞: ' + error.message, 'error');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        async function createRoom() {
            try {
                const response = await fetch('/video/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: JSON.stringify({
                        room_name: '–ö–æ–º–Ω–∞—Ç–∞ ' + new Date().toLocaleTimeString(),
                        max_participants: 10,
                        recording_enabled: true
                    })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
                }

                const room = await response.json();
                document.getElementById('roomCode').value = room.room_code;
                showMessage('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + room.room_code, 'success');
                
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message, 'error');
            }
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        async function joinRoom() {
            roomCode = document.getElementById('roomCode').value;
            userName = document.getElementById('userName').value;

            if (!roomCode || !userName) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
                const response = await fetch(`/video/rooms/${roomCode}/join`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
                }

                const participant = await response.json();
                
                // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                connectWebSocket(roomCode, participant.participant_id);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('connectionForm').style.display = 'none';
                document.getElementById('videoContainer').style.display = 'grid';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('participantsList').style.display = 'block';
                
                showMessage('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ', 'success');
                
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        function connectWebSocket(roomCode, participantId) {
            ws = new WebSocket(`ws://localhost:8000/video/ws/${roomCode}/${participantId}`);
            
            ws.onopen = () => {
                isConnected = true;
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω', 'connected');
                showMessage('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
            };
            
            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                await handleWebSocketMessage(message);
            };
            
            ws.onclose = () => {
                isConnected = false;
                updateStatus('–û—Ç–∫–ª—é—á–µ–Ω', 'disconnected');
                showMessage('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
            };
            
            ws.onerror = (error) => {
                showMessage('–û—à–∏–±–∫–∞ WebSocket: ' + error, 'error');
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
        async function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'offer':
                    await handleOffer(message.data);
                    break;
                case 'answer':
                    await handleAnswer(message.data);
                    break;
                case 'ice-candidate':
                    await handleIceCandidate(message.data);
                    break;
                case 'participant_joined':
                    addParticipant(message.data);
                    break;
                case 'participant_left':
                    removeParticipant(message.data.participant_id);
                    break;
                case 'participant_status':
                    updateParticipantStatus(message.data);
                    break;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function createPeerConnection() {
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
            pc.ontrack = (event) => {
                const [remoteStream] = event.streams;
                const participantId = event.track.id;
                
                remoteStreams.set(participantId, remoteStream);
                addRemoteVideo(participantId, remoteStream);
            };

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        data: event.candidate
                    }));
                }
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ WebRTC offer
        async function handleOffer(offer) {
            if (!pc) {
                createPeerConnection();
            }
            
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            ws.send(JSON.stringify({
                type: 'answer',
                data: answer
            }));
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ WebRTC answer
        async function handleAnswer(answer) {
            if (pc) {
                await pc.setRemoteDescription(answer);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        async function handleIceCandidate(candidate) {
            if (pc) {
                await pc.addIceCandidate(candidate);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
        function toggleMute() {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('muteBtn').textContent = 
                    audioTrack.enabled ? 'üîá –ó–∞–≥–ª—É—à–∏—Ç—å' : 'üîä –í–∫–ª—é—á–∏—Ç—å';
            }
        }

        function toggleVideo() {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('videoBtn').textContent = 
                    videoTrack.enabled ? 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
            }
        }

        async function toggleScreenShare() {
            try {
                if (document.getElementById('screenBtn').textContent.includes('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞')) {
                    // –ù–∞—á–∞–ª–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
                    const screenStream = await navigator.mediaDevices.getDisplayMedia();
                    const videoTrack = screenStream.getVideoTracks()[0];
                    
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(videoTrack);
                    }
                    
                    document.getElementById('screenBtn').textContent = 'üñ•Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é';
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    videoTrack.onended = () => {
                        const originalTrack = localStream.getVideoTracks()[0];
                        sender.replaceTrack(originalTrack);
                        document.getElementById('screenBtn').textContent = 'üñ•Ô∏è –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞';
                    };
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞: ' + error.message, 'error');
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
        function addParticipant(participant) {
            participants.set(participant.participant_id, participant);
            updateParticipantsList();
            updateParticipantsCount();
        }

        function removeParticipant(participantId) {
            participants.delete(participantId);
            removeRemoteVideo(participantId);
            updateParticipantsList();
            updateParticipantsCount();
        }

        function updateParticipantStatus(data) {
            const participant = participants.get(data.participant_id);
            if (participant) {
                Object.assign(participant, data);
                updateParticipantsList();
            }
        }

        function addRemoteVideo(participantId, stream) {
            const container = document.getElementById('remoteVideos');
            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.id = `video-${participantId}`;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.srcObject = stream;
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = participants.get(participantId)?.user_name || '–£—á–∞—Å—Ç–Ω–∏–∫';
            
            wrapper.appendChild(video);
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        }

        function removeRemoteVideo(participantId) {
            const video = document.getElementById(`video-${participantId}`);
            if (video) {
                video.remove();
            }
        }

        function updateParticipantsList() {
            const container = document.getElementById('participants');
            container.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = `participant ${participant.role === 'host' ? 'host' : ''} ${participant.is_muted ? 'muted' : ''}`;
                
                div.innerHTML = `
                    <div class="participant-name">${participant.user_name || '–£—á–∞—Å—Ç–Ω–∏–∫'}</div>
                    <div class="participant-status">
                        ${participant.is_muted ? 'üîá' : 'üîä'} 
                        ${participant.is_video_enabled ? 'üìπ' : 'üì∑'} 
                        ${participant.role}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function updateParticipantsCount() {
            document.getElementById('participantsCount').textContent = participants.size + 1; // +1 –¥–ª—è —Å–µ–±—è
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
        function leaveRoom() {
            if (ws) {
                ws.close();
            }
            
            if (pc) {
                pc.close();
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // –°–±—Ä–æ—Å UI
            document.getElementById('connectionForm').style.display = 'block';
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('participantsList').style.display = 'none';
            document.getElementById('roomInfo').style.display = 'none';
            
            participants.clear();
            remoteStreams.clear();
            
            updateStatus('–û—Ç–∫–ª—é—á–µ–Ω', 'disconnected');
            showMessage('–ü–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É', 'success');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateStatus(text, className) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = `status ${className}`;
        }

        function showMessage(text, type) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = text;
            messages.appendChild(div);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function getAuthToken() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            return 'your-auth-token-here';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = init;
    </script>
</body>
</html>
