<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn.danger {
            background: #f44336;
        }
        .btn.danger:hover {
            background: #d32f2f;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .success {
            background: #e8f5e8;
            border-left-color: #4CAF50;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .video-wrapper {
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        video {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤</h1>
        
        <div class="status" id="status">
            –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
        </div>

        <div>
            <input type="text" id="roomCode" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" value="TEST001">
            <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" value="–¢–µ—Å—Ç–µ—Ä">
            <button class="btn" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            <button class="btn danger" onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å</button>
        </div>

        <div>
            <button class="btn" onclick="toggleMute()">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
            <button class="btn" onclick="toggleVideo()">üìπ –ö–∞–º–µ—Ä–∞</button>
            <button class="btn" onclick="toggleScreenShare()">üñ•Ô∏è –≠–∫—Ä–∞–Ω</button>
        </div>

        <div class="video-container" id="videoContainer">
            <!-- –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>

        <div>
            <h3>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        let localStream = null;
        let peerConnections = new Map();
        let remoteStreams = new Map();
        let socket = null;
        let roomCode = '';
        let userId = '';
        let userName = '';
        let isMuted = false;
        let isVideoEnabled = true;

        const iceConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function getWebSocketHost() {
            // –ï—Å–ª–∏ –º—ã –Ω–∞ localhost, –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return window.location.host;
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
            return window.location.host;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateDebugInfo() {
            const debug = document.getElementById('debugInfo');
            debug.innerHTML = `
                <p><strong>–ö–æ–º–Ω–∞—Ç–∞:</strong> ${roomCode}</p>
                <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${userName} (${userId})</p>
                <p><strong>Peer Connections:</strong> ${peerConnections.size}</p>
                <p><strong>–£–¥–∞–ª–µ–Ω–Ω—ã–µ –ø–æ—Ç–æ–∫–∏:</strong> ${remoteStreams.size}</p>
                <p><strong>WebSocket:</strong> ${socket ? socket.readyState : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}</p>
                <p><strong>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫:</strong> ${localStream ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</p>
            `;
        }

        async function joinRoom() {
            try {
                roomCode = document.getElementById('roomCode').value;
                userName = document.getElementById('userName').value;
                userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                updateStatus('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º...', 'info');

                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                addVideoElement(userId, localStream, userName + ' (–í—ã)', true);

                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');

                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = getWebSocketHost();
                const wsUrl = `${protocol}//${host}/video/ws/${roomCode}?user_id=${userId}`;
                
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
                
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ', 'success');
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    socket.send(JSON.stringify({
                        type: 'user_info',
                        user_id: userId,
                        user_name: userName
                    }));

                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    socket.send(JSON.stringify({ type: 'get_participants' }));
                };

                socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                    handleWebSocketMessage(message);
                };

                socket.onclose = () => {
                    updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'error');
                };

                socket.onerror = (error) => {
                    updateStatus('–û—à–∏–±–∫–∞ WebSocket: ' + error, 'error');
                };

            } catch (error) {
                updateStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É:', error);
            }
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'user_joined':
                    handleUserJoined(message);
                    break;
                case 'user_left':
                    handleUserLeft(message);
                    break;
                case 'webrtc_signal':
                    handleWebRTCSignal(message);
                    break;
                case 'participants_list':
                    handleParticipantsList(message);
                    break;
            }
            updateDebugInfo();
        }

        function handleUserJoined(message) {
            const { user_id, user_name } = message;
            if (user_id !== userId) {
                console.log(`–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫: ${user_name} (${user_id})`);
                createPeerConnection(user_id);
            }
        }

        function handleUserLeft(message) {
            const { user_id } = message;
            removeVideoElement(user_id);
            closePeerConnection(user_id);
        }

        function handleWebRTCSignal(message) {
            const { signal_type, data, sender_user_id } = message;
            if (sender_user_id === userId) return;

            switch (signal_type) {
                case 'offer':
                    handleOffer(data, sender_user_id);
                    break;
                case 'answer':
                    handleAnswer(data, sender_user_id);
                    break;
                case 'ice_candidate':
                    handleIceCandidate(data, sender_user_id);
                    break;
            }
        }

        function handleParticipantsList(message) {
            const { participants } = message;
            participants.forEach(participant => {
                if (participant.user_id !== userId) {
                    createPeerConnection(participant.user_id);
                }
            });
        }

        async function createPeerConnection(targetUserId) {
            try {
                console.log(`–°–æ–∑–¥–∞–Ω–∏–µ peer connection –¥–ª—è ${targetUserId}`);
                
                const peerConnection = new RTCPeerConnection(iceConfig);

                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏
                peerConnection.ontrack = (event) => {
                    console.log(`–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫ –æ—Ç ${targetUserId}`);
                    const [remoteStream] = event.streams;
                    remoteStreams.set(targetUserId, remoteStream);
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const participantName = `–£—á–∞—Å—Ç–Ω–∏–∫ ${targetUserId.substr(-4)}`;
                    addVideoElement(targetUserId, remoteStream, participantName, false);
                };

                // –°–æ–±–∏—Ä–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({
                            type: 'webrtc_signal',
                            signal_type: 'ice_candidate',
                            data: event.candidate,
                            target_user_id: targetUserId,
                            sender_user_id: userId
                        }));
                    }
                };

                peerConnections.set(targetUserId, peerConnection);

                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.send(JSON.stringify({
                    type: 'webrtc_signal',
                    signal_type: 'offer',
                    data: offer,
                    target_user_id: targetUserId,
                    sender_user_id: userId
                }));

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è peer connection:', error);
            }
        }

        async function handleOffer(offer, senderUserId) {
            try {
                let peerConnection = peerConnections.get(senderUserId);
                
                if (!peerConnection) {
                    peerConnection = new RTCPeerConnection(iceConfig);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    if (localStream) {
                        localStream.getTracks().forEach(track => {
                            peerConnection.addTrack(track, localStream);
                        });
                    }

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏
                    peerConnection.ontrack = (event) => {
                        console.log(`–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫ –æ—Ç ${senderUserId}`);
                        const [remoteStream] = event.streams;
                        remoteStreams.set(senderUserId, remoteStream);
                        
                        const participantName = `–£—á–∞—Å—Ç–Ω–∏–∫ ${senderUserId.substr(-4)}`;
                        addVideoElement(senderUserId, remoteStream, participantName, false);
                    };

                    // –°–æ–±–∏—Ä–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            socket.send(JSON.stringify({
                                type: 'webrtc_signal',
                                signal_type: 'ice_candidate',
                                data: event.candidate,
                                target_user_id: senderUserId,
                                sender_user_id: userId
                            }));
                        }
                    };

                    peerConnections.set(senderUserId, peerConnection);
                }

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                socket.send(JSON.stringify({
                    type: 'webrtc_signal',
                    signal_type: 'answer',
                    data: answer,
                    target_user_id: senderUserId,
                    sender_user_id: userId
                }));

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer:', error);
            }
        }

        async function handleAnswer(answer, senderUserId) {
            try {
                const peerConnection = peerConnections.get(senderUserId);
                if (peerConnection) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer:', error);
            }
        }

        async function handleIceCandidate(candidate, senderUserId) {
            try {
                const peerConnection = peerConnections.get(senderUserId);
                if (peerConnection) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ICE candidate:', error);
            }
        }

        function addVideoElement(userId, stream, name, isLocal) {
            const container = document.getElementById('videoContainer');
            
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
            const existing = document.getElementById(`video-${userId}`);
            if (existing) {
                existing.parentElement.remove();
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            if (isLocal) {
                wrapper.style.border = '3px solid #4CAF50';
            }

            const video = document.createElement('video');
            video.id = `video-${userId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.muted = true;
            video.playsInline = true;

            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = name;

            wrapper.appendChild(video);
            wrapper.appendChild(label);
            container.appendChild(wrapper);

            console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤–∏–¥–µ–æ –¥–ª—è ${name} (${userId})`);
        }

        function removeVideoElement(userId) {
            const element = document.getElementById(`video-${userId}`);
            if (element) {
                element.parentElement.remove();
                remoteStreams.delete(userId);
            }
        }

        function closePeerConnection(userId) {
            const peerConnection = peerConnections.get(userId);
            if (peerConnection) {
                peerConnection.close();
                peerConnections.delete(userId);
            }
        }

        function leaveRoom() {
            if (socket) {
                socket.close();
            }
            
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            remoteStreams.clear();
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('videoContainer').innerHTML = '';
            updateStatus('–ü–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É', 'info');
            updateDebugInfo();
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    updateStatus(`–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${isMuted ? '–≤—ã–∫–ª—é—á–µ–Ω' : '–≤–∫–ª—é—á–µ–Ω'}`, isMuted ? 'error' : 'success');
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoEnabled = videoTrack.enabled;
                    updateStatus(`–ö–∞–º–µ—Ä–∞ ${isVideoEnabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞'}`, isVideoEnabled ? 'success' : 'error');
                }
            }
        }

        function toggleScreenShare() {
            updateStatus('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏', 'error');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', () => {
            updateDebugInfo();
            console.log('–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });
    </script>
</body>
</html>
